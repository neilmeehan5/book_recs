DROP TABLE IF EXISTS BUILD_TAGS;

CREATE TABLE BUILD_TAGS AS
WITH A AS (
    SELECT WORK_ID
    FROM GOODREADS_BOOKS
    GROUP BY WORK_ID
    HAVING SUM(RATINGS_COUNT) >= 500
), 
B AS (
    SELECT 
        WORK_ID,
        REPLACE(REPLACE(REPLACE(UPPER(NAME), '-', ' '), '_', ' '), '0', '') AS TAG_NAME,
        MAX(COUNT) AS TAG_COUNT --SHOULD THIS BE A SUM NOW PERHAPS?
    FROM TAGS
    INNER JOIN A
    USING(WORK_ID)
    GROUP BY WORK_ID, TAG_NAME
)
SELECT 
    WORK_ID,
    TAG_NAME,
    TAG_COUNT,
    SUM(TAG_COUNT) OVER(PARTITION BY WORK_ID) AS WORK_TOTAL_COUNT,
    SUM(TAG_COUNT) OVER(PARTITION BY TAG_NAME) AS TAG_TOTAL_COUNT,
    COUNT(WORK_ID) OVER(PARTITION BY TAG_NAME) AS TAG_NUM_WORK
FROM B;

ALTER TABLE BUILD_TAGS 
ADD PRIMARY KEY (WORK_ID, TAG_NAME);